<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MainPlot ‚Äî v4.0 (Two‚ÄëStep Actions ‚Ä¢ Options Strip ‚Ä¢ Robust Copy)</title>
<style>
  :root{ --bg:#0f1115; --panel:#141822; --ink:#e7eaf0; --muted:#9aa4b2; --accent:#7c92ff; --accent-2:#41d6b6; --btn:#1b2130; --btn-hover:#222a3d; --border:#273047; --danger:#ff6b6b; --warn:#ffcc66; --ok:#41d6b6; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)}
  header h1{font-size:15px;margin:0;font-weight:700}
  header .actions{display:flex;gap:8px;align-items:center}
  .tag{font-size:12px;color:var(--muted)}
  button{background:var(--btn);color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer}
  button:hover{background:var(--btn-hover)}
  .pill{border-radius:999px}
  .chip{border-radius:999px;padding:6px 10px;border:1px solid var(--border);background:#0d1018;cursor:pointer}
  .chip.active{outline:1px solid var(--accent); background:#111728}
  .chip:hover{background:#12192c}
  .small{font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
  textarea, input[type="text"], select{width:100%;background:#0d1018;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:10px;outline:none}
  textarea:focus, input:focus, select:focus{border-color:var(--accent)}
  textarea{resize:none}
  /* layout */
  .app{display:grid;grid-template-columns:300px 1fr 360px;gap:10px;height:calc(100vh - 48px);padding:10px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .pad{padding:10px}
  .flexcol{display:flex;flex-direction:column;min-height:0}
  .hr{height:1px;background:var(--border);margin:10px 0}
  /* left tree */
  .tree-header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border)}
  .row{display:flex;gap:6px;align-items:center}
  .tree{padding:8px 6px 10px 6px;overflow:auto}
  .node{display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:8px}
  .node:hover{background:#0d121d}
  .node .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .node .ops{display:none;gap:6px}
  .node:hover .ops{display:flex}
  .node.active{background:#0d121d;border:1px solid var(--border)}
  .node.selected{outline:1px solid var(--accent)}
  .icon{font:14px/1 ui-monospace,Menlo}
  /* DnD hints */
  .node.dragging{opacity:.5}
  .node.drop-before{box-shadow:inset 0 2px 0 var(--accent)}
  .node.drop-after{box-shadow:inset 0 -2px 0 var(--accent)}
  .node.drop-inside{outline:1px dashed var(--accent)}
  /* center editor */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .options{display:none;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .options.open{display:flex}
  .options .group{display:flex;gap:6px;align-items:center}
  .options .label{font-size:12px;color:var(--muted);margin-right:2px}
  .editor-wrap{display:flex;flex-direction:column;min-height:0;flex:1}
  .area{flex:1 1 0%;min-height:120px;}
  .preview{background:#0b0e14;border:1px dashed var(--border);border-radius:8px;padding:10px;overflow:auto;white-space:pre-wrap}
  #dragbar{height:12px;cursor:row-resize;background:linear-gradient(180deg,rgba(255,255,255,.08),transparent);border:1px solid var(--border);border-radius:8px;position:relative}
  #dragbar::after{content:"‚â°";position:absolute;left:50%;top:50%;transform:translate(-50%,-55%);font:16px/1 ui-monospace;opacity:.45}
  #dragbar:hover{background:linear-gradient(180deg,rgba(255,255,255,.12),transparent)}
  /* collapsers */
  .hidden{display:none}
  @media (max-width:1200px){ .app{grid-template-columns:250px 1fr 320px} }
  @media (max-width:980px){ .app{grid-template-columns:1fr} #right,#left{display:none} }

  /* Help modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:9999}
  .modal.open{display:flex}
  .modal-card{width:min(860px,92vw);max-height:88vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  .modal-card h2{margin:0 0 6px 0;font-size:16px}
  .kbd{display:inline-block;min-width:24px;padding:2px 6px;border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;background:#0d1018;font:12px/1.4 ui-monospace,Menlo;color:var(--ink);text-align:center}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media (min-width:620px){ .grid{grid-template-columns:1fr 1fr} }

  /* Debug console */
  #debug{position:fixed;right:14px;bottom:14px;width:min(720px,92vw);max-height:50vh;display:none;flex-direction:column;gap:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);z-index:10000}
  #debug.open{display:flex}
  #debug pre{margin:0;background:#0b0e14;border:1px solid var(--border);border-radius:8px;padding:8px;max-height:36vh;overflow:auto;white-space:pre-wrap}

  /* Name dialog */
  #nameModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:10001}
  #nameModal.open{display:flex}
  #nameCard{width:min(440px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
  #nameCard .row{justify-content:flex-end}

  /* Raw JSON modal (backup fallback) */
  #rawModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:10002}
  #rawModal.open{display:flex}
  #rawCard{width:min(860px,92vw);max-height:88vh;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
  #rawCard textarea{height:50vh}

  /* helper link */
  #backupManual{display:none;margin-left:8px}
</style>
</head>
<body>
<header>
  <h1>MainPlot ‚Äî v4.0</h1>
  <div class="actions">
    <button id="toggleLeft" class="pill" title="Toggle folders (Ctrl/Cmd+Alt+L)">‚üµ‚ü∂ Folders</button>
    <button id="toggleRight" class="pill" title="Toggle notes/outline (Ctrl/Cmd+Alt+N)">‚ü∑‚üµ Notes</button>
    <button id="helpBtn" class="pill" title="Help (F1 or Shift+/)">‚ùì Help</button>
    <span class="tag">Autosave + Backup</span>
  </div>
</header>

<div class="app">
  <!-- LEFT: Project title + folders / scenes -->
  <aside id="left" class="panel" aria-label="Project tree">
    <div class="pad" style="border-bottom:1px solid var(--border)">
      <label class="small">Project Title</label>
      <input id="projectTitle" type="text" placeholder="e.g. Ghost Circuit" title="Project title (used in prompts & backups)">
    </div>

    <div class="tree-header">
      <strong>Project</strong>
      <div class="row">
        <button id="addFolder" class="pill" title="Add folder under selected folder or root">üìÅ+</button>
        <button id="addScene"  class="pill" title="Add new scene under selected folder or root">üìÑ+</button>
        <button id="backup"    class="pill" title="Save full project backup (Ctrl/Cmd+B). If download is blocked, a manual link appears below.">Backup</button>
        <button id="restore"   class="pill" title="Restore from backup file (Ctrl/Cmd+O)">Restore</button>
        <input id="restoreFile" type="file" accept="application/json" class="hidden" />
      </div>
    </div>
    <div class="pad" style="padding-top:6px;padding-bottom:0">
      <span id="backupStatus" class="small" aria-live="polite"></span>
      <a id="backupManual" class="small" download target="_blank">Click here if download didn't start</a>
    </div>
    <div id="tree" class="tree" title="Tip: drag items to reorder or nest into folders"></div>
  </aside>

  <!-- CENTER: editor + preview (resizable) -->
  <section id="center" class="panel" aria-label="Editor and Prompt">
    <div class="pad flexcol">
      <div class="row" style="justify-content:space-between">
        <input id="title" type="text" placeholder="Untitled scene" style="max-width:520px" title="Scene title" aria-label="Scene title">
        <div class="row small"><span id="wc" title="Word count">0 words</span></div>
      </div>

      <div class="hr"></div>

      <div class="toolbar" role="toolbar" aria-label="AI actions">
        <button class="btn" data-action="continue"  title="Continue the scene (Alt+1)">Continue</button>
        <button class="btn" data-action="rewrite"   title="Rewrite selection on‚Äëvoice (Alt+2)">Rewrite Selection</button>
        <button class="btn" data-action="expand"    title="Expand selection with vivid detail (Alt+3)">Expand</button>
        <button class="btn" data-action="conflict"  title="Introduce organic conflict/tension (Alt+4)">Add Conflict</button>
        <button class="btn" data-action="describe"  title="POV sensory description (Alt+5)">Describe (5 senses)</button>
        <button class="btn" data-action="summarize" title="Summarize beats/turning point (Alt+6)">Summarize</button>
        <button class="btn" data-action="brainstorm" title="Brainstorm next beats with tradeoffs (Alt+7)">Brainstorm</button>
        <button id="copyPrompt" class="pill" style="margin-left:auto" title="Copy prompt to clipboard (Ctrl/Cmd+Shift+C)">Copy to ChatGPT</button>
        <span id="copyStatus" class="small" aria-live="polite"></span>
      </div>
      <div id="optionsStrip" class="options" aria-live="polite"></div>

      <div class="hr"></div>

      <div class="editor-wrap" title="Drag the handle to resize. Double‚Äëclick the handle to reset 50/50.">
        <textarea id="scene" class="area" placeholder="Write your scene here." title="Scene editor"></textarea>
        <div id="dragbar" title="Drag to resize (double‚Äëclick to reset)"></div>
        <textarea id="preview" class="preview area" placeholder="Your assembled prompt will appear here. You can edit it before copying." spellcheck="false" title="Editable prompt preview"></textarea>
      </div>
    </div>
  </section>

  <!-- RIGHT: notes / style / OUTLINE -->
  <aside id="right" class="panel" aria-label="Notes and Outline">
    <div class="pad" style="display:flex;flex-direction:column;gap:10px">
      <div>
        <label class="small">Project Notes (canon / world / characters)</label>
        <textarea id="notes" rows="8" placeholder="Key facts to keep canon." title="Project notes"></textarea>
      </div>
      <div>
        <label class="small">Style Guide (voice, tense, constraints)</label>
        <textarea id="style" rows="6" placeholder="1st‚Äëperson present, clipped noir voice." title="Style guide"></textarea>
      </div>
      <div class="row">
        <div style="flex:1">
          <label class="small">Tone</label>
          <select id="tone" title="Preferred tone">
            <option value="">(inherit)</option><option>Neutral</option><option>Suspenseful</option>
            <option>Romantic</option><option>Whimsical</option><option>Dark</option>
            <option>Gritty</option><option>Hopeful</option>
          </select>
        </div>
        <div style="flex:1">
          <label class="small">Creativity</label>
          <select id="creativity" title="Creativity level">
            <option value="balanced">Balanced</option>
            <option value="precise">Precise</option>
            <option value="imaginative">Imaginative</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <label class="small">Outline (global)</label>
        <div class="row" style="justify-content:space-between">
          <label class="small" title="Include a chapter‚Äërelevant slice of the outline in prompts"><input id="outlineEnabled" type="checkbox" checked> Include in prompts</label>
          <div class="row" style="gap:6px">
            <button id="btnGenOutline" class="pill" title="Build outline from notes (Ctrl/Cmd+Shift+G)">Generate Outline</button>
            <button id="btnSceneToOutline" class="pill" title="Turn current scene into outline beats (Ctrl/Cmd+Shift+S)">Summarize Scene ‚Üí Outline</button>
            <button id="exportOutline" class="pill" title="Export outline as Markdown">Export .md</button>
          </div>
        </div>
        <textarea id="outline" rows="12" placeholder="# Outline v1
## Act I
### Chapter 1: Title
- Beat: ...
### Chapter 2: ...
- Beat: ..." title="Global outline (Markdown with ### Chapter headings)"></textarea>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="exportTxt" class="pill" title="Export current scene as .txt (Ctrl/Cmd+E)">Export Scene .txt</button>
      </div>
    </div>
  </aside>
</div>

<!-- Help modal -->
<div id="helpModal" class="modal" aria-hidden="true" role="dialog" aria-label="Help and Shortcuts">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h2>Help & Shortcuts</h2>
      <button id="helpClose" class="pill" title="Close (Esc)">Close</button>
    </div>
    <p class="small">Two‚Äëstep flow: Click a plot button ‚Üí an editable prompt is built in the preview. A compact options strip appears; click any option to regenerate using that setting. All actions are single left‚Äëclicks. Hotkeys are optional.</p>
    <div class="hr"></div>
    <div class="grid">
      <div>
        <h3 class="small" style="margin:0 0 6px 0">Trigger AI actions</h3>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">1</span> Continue</div>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">2</span> Rewrite Selection</div>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">3</span> Expand</div>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">4</span> Add Conflict</div>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">5</span> Describe (5 senses)</div>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">6</span> Summarize</div>
        <div class="small"><span class="kbd">Alt</span>+<span class="kbd">7</span> Brainstorm</div>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px 0">Build, copy, panels</h3>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">Enter</span> Smart build (Rewrite if text is selected, else last action)</div>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">‚áß</span>+<span class="kbd">C</span> Copy prompt to clipboard</div>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">Alt</span>+<span class="kbd">L</span> Toggle Folders</div>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">Alt</span>+<span class="kbd">N</span> Toggle Notes/Outline</div>
        <div class="small"><span class="kbd">F1</span> or <span class="kbd">Shift</span>+<span class="kbd">?</span> Open Help</div>
        <div class="small"><span class="kbd">Esc</span> Close Help</div>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px 0">Outline tools</h3>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">‚áß</span>+<span class="kbd">G</span> Generate Outline</div>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">‚áß</span>+<span class="kbd">S</span> Scene ‚Üí Outline beats</div>
      </div>
      <div>
        <h3 class="small" style="margin:0 0 6px 0">Backup & export</h3>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">B</span> Backup JSON</div>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">O</span> Restore JSON</div>
        <div class="small"><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">E</span> Export current scene .txt</div>
      </div>
    </div>
  </div>
</div>

<!-- Debug console -->
<div id="debug" role="region" aria-label="Debug Console">
  <div class="row" style="justify-content:space-between">
    <strong>Debug Console</strong>
    <div class="row">
      <button id="dbgCopy" class="pill" title="Copy logs">Copy</button>
      <button id="dbgClear" class="pill" title="Clear logs">Clear</button>
      <button id="dbgClose" class="pill" title="Close (Ctrl/Cmd+D)">Close</button>
    </div>
  </div>
  <pre id="dbgOut" tabindex="0"></pre>
</div>

<!-- Name dialog (replaces browser prompt) -->
<div id="nameModal" role="dialog" aria-modal="true" aria-labelledby="nameTitle">
  <div id="nameCard">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="nameTitle" style="margin:0">Name</h3>
      <button id="nameClose" class="pill">‚úï</button>
    </div>
    <label for="nameInput" class="small" id="nameLabel">Name</label>
    <input id="nameInput" type="text" />
    <div class="row">
      <button id="nameCancel" class="pill">Cancel</button>
      <button id="nameOk" class="pill">OK</button>
    </div>
  </div>
</div>

<!-- RAW JSON modal (fallback for backup) -->
<div id="rawModal" aria-modal="true" role="dialog" aria-labelledby="rawTitle">
  <div id="rawCard">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="rawTitle" style="margin:0">Backup JSON</h3>
      <button id="rawClose" class="pill">‚úï</button>
    </div>
    <textarea id="rawText" spellcheck="false"></textarea>
    <div class="row" style="justify-content:flex-end">
      <button id="rawCopy" class="pill">Copy</button>
      <button id="rawHide" class="pill">Close</button>
    </div>
  </div>
</div>

<script>
  // Delay all logic until DOM is ready to avoid null elements.
  document.addEventListener('DOMContentLoaded', () => {
    /* ===== Helpers ===== */
    const $ = (id) => document.getElementById(id);
    const on = (el, evt, handler, name) => { if(el && el.addEventListener){ el.addEventListener(evt, handler); } else { console.warn('Listener skipped (missing el):', name || (el && el.id) || evt); } };

    /* ===== Debug Console (safe init) ===== */
    const Debug = (() => {
      const out = $('dbgOut');
      const box = $('debug');
      const buf = [];
      const MAX = 2000;
      function add(line){ try { const ts=new Date().toISOString().split('T')[1].replace('Z',''); buf.push(`[${ts}] ${line}`); if(buf.length>MAX) buf.shift(); if(out){ out.textContent = buf.join('\n'); out.scrollTop = out.scrollHeight; } } catch {} }
      function open(){ box && box.classList.add('open'); }
      function close(){ box && box.classList.remove('open'); }
      function toggle(){ box && box.classList.toggle('open'); }
      ['log','warn','error'].forEach(fn => { const orig = console[fn].bind(console); console[fn] = (...args) => { try{ add(fn.toUpperCase()+': '+args.map(a => (typeof a==='string'?a:JSON.stringify(a))).join(' ')); }catch{} orig(...args); }; });
      window.addEventListener('error', e=> add('ERROR: '+e.message+' @ '+e.filename+':'+e.lineno));
      window.addEventListener('unhandledrejection', e=> add('REJECTION: '+(e.reason && e.reason.message || e.reason)));
      on($('dbgCopy'),'click', async () => { try{ await navigator.clipboard.writeText(out?.textContent||''); console.log('Copied debug logs'); }catch{ add('WARN: Clipboard write failed'); } }, 'dbgCopy');
      on($('dbgClear'),'click', () => { buf.length=0; if(out) out.textContent=''; }, 'dbgClear');
      on($('dbgClose'),'click', close, 'dbgClose');
      return { add, open, close, toggle };
    })();

    console.log('MainPlot v4.0 booting‚Ä¶');

    /* ===== Name dialog ===== */
    function nameDialog({title='Name', label='Name', value='', placeholder='' }={}){
      return new Promise(resolve=>{
        const modal=$('nameModal'); const input=$('nameInput'); const ok=$('nameOk'); const cancel=$('nameCancel'); const close=$('nameClose');
        if(!modal||!input||!ok||!cancel||!close){ console.warn('Name dialog missing elements'); resolve(null); return; }
        $('nameTitle').textContent=title; $('nameLabel').textContent=label; input.value=value||''; input.placeholder=placeholder||'';
        function done(val){ modal.classList.remove('open'); modal.removeEventListener('keydown', onKey); resolve(val); }
        function onKey(e){ if(e.key==='Enter'){ e.preventDefault(); ok.click(); } if(e.key==='Escape'){ e.preventDefault(); cancel.click(); } }
        ok.onclick=()=>{ const v=input.value.trim(); if(!v){ input.focus(); return; } done(v); };
        cancel.onclick=()=> done(null); close.onclick=()=> done(null);
        modal.classList.add('open'); setTimeout(()=>{ input.focus(); input.select(); }, 0); modal.addEventListener('keydown', onKey);
      });
    }

    /* ===== State ===== */
    const LS_KEY='mainplot_v40_state';
    let state = load() || makeDefaultState();
    let lastAction = 'continue';
    let selectedFolderId = null;

    function makeDefaultState(){ return { meta:{ projectTitle:'Untitled', notes:'', style:'', tone:'', creativity:'balanced', outline:'', outlineEnabled:true, actionOptions:{} }, tree:[ {id:id(), type:'folder', name:'Draft', children:[ {id:id(), type:'scene', name:'Chapter 1: Opening', content:''} ]} ], currentId:null }; }
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||''); }catch(e){ console.error('Load failed',e); return null; } }
    function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){ console.error('Save failed',e); } }
    function id(){ return 'n'+Math.random().toString(36).slice(2,9); }

    function findNode(arr, nid){ for(const n of arr){ if(n.id===nid) return n; if(n.type==='folder'){ const f=findNode(n.children||[], nid); if(f) return f; } } return null; }
    function findParent(arr, nid, parent=null){ for(let i=0;i<arr.length;i++){ const n=arr[i]; if(n.id===nid) return {parentArray:arr, parentNode:parent, index:i}; if(n.type==='folder'){ const r=findParent(n.children||[], nid, n); if(r) return r; } } return null; }
    function removeById(nid){ const p=findParent(state.tree, nid); if(!p) return null; return p.parentArray.splice(p.index,1)[0]; }
    function isDescendant(ancestorId, childId){ const anc=findNode(state.tree, ancestorId); if(!anc || anc.type!=='folder') return false; function walk(list){ for(const n of list){ if(n.id===childId) return true; if(n.type==='folder' && walk(n.children||[])) return true; } return false; } return walk(anc.children||[]); }

    /* ===== Refs ===== */
    const els={ left:$('left'), right:$('right'), tree:$('tree'), addFolder:$('addFolder'), addScene:$('addScene'), backup:$('backup'), restore:$('restore'), restoreFile:$('restoreFile'), title:$('title'), scene:$('scene'), preview:$('preview'), wc:$('wc'), projectTitle:$('projectTitle'), notes:$('notes'), style:$('style'), tone:$('tone'), creativity:$('creativity'), outline:$('outline'), outlineEnabled:$('outlineEnabled'), btnGenOutline:$('btnGenOutline'), btnSceneToOutline:$('btnSceneToOutline'), exportOutline:$('exportOutline'), exportTxt:$('exportTxt'), copyPrompt:$('copyPrompt'), copyStatus:$('copyStatus'), toggleLeft:$('toggleLeft'), toggleRight:$('toggleRight'), helpBtn:$('helpBtn'), helpModal:$('helpModal'), helpClose:$('helpClose'), backupStatus:$('backupStatus'), backupManual:$('backupManual'), optionsStrip:$('optionsStrip') };

    /* ===== Init ===== */
    try{ hydrateMeta(); renderTree(); openFirstScene(); }catch(err){ console.error('Init crashed', err); Debug.open(); }

    function hydrateMeta(){ if(!els.projectTitle) return; els.projectTitle.value=state.meta.projectTitle||''; els.notes.value=state.meta.notes||''; els.style.value=state.meta.style||''; els.tone.value=state.meta.tone||''; els.creativity.value=state.meta.creativity||'balanced'; els.outline.value=state.meta.outline||''; els.outlineEnabled.checked = state.meta.outlineEnabled ?? true; document.title = `${state.meta.projectTitle||'Untitled'} ‚Äî MainPlot v4.0`; }
    function openFirstScene(){ if(state.currentId && findNode(state.tree,state.currentId)){ openNode(state.currentId); return; } const first = firstScene(state.tree); if(first) openNode(first.id); }
    function firstScene(arr){ for(const n of arr){ if(n.type==='scene') return n; if(n.type==='folder'){ const s=firstScene(n.children||[]); if(s) return s; } } }

    /* ===== Tree UI + DnD ===== */
    let draggingId=null, dropTarget=null;
    function renderTree(){ if(!Array.isArray(state.tree)) state.tree=[]; if(!els.tree) return; els.tree.innerHTML=''; state.tree.forEach(n=> renderNode(n, els.tree, 0)); }
    function renderNode(n, container, depth){ const div=document.createElement('div'); div.className='node'+(n.id===state.currentId?' active':'')+((n.id===selectedFolderId)?' selected':''); if(depth) div.style.marginLeft=(depth*14)+'px'; div.title = n.type==='scene' ? 'Open scene' : 'Select folder (for Add & Drop)'; div.draggable=true; const icon=document.createElement('span'); icon.className='icon'; icon.textContent = n.type==='folder' ? 'üìÅ' : 'üìÑ'; const name=document.createElement('div'); name.className='name'; name.textContent=n.name; const ops=document.createElement('div'); ops.className='ops'; const rn=smallBtn('‚úé',()=>renameNode(n.id),'Rename'); const del=smallBtn('üóë',()=>deleteNode(n.id),'Delete'); ops.appendChild(rn); ops.appendChild(del); div.appendChild(icon); div.appendChild(name); div.appendChild(ops); div.addEventListener('click',(e)=>{ if(e.target===rn||e.target===del) return; if(n.type==='scene'){ openNode(n.id); selectedFolderId=null; renderTree(); } else { selectedFolderId=n.id; renderTree(); } }); div.addEventListener('dragstart',(e)=>{ draggingId=n.id; div.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', n.id); }); div.addEventListener('dragend',()=>{ draggingId=null; clearDropStyles(); }); div.addEventListener('dragover',(e)=>{ if(!draggingId || draggingId===n.id) return; e.preventDefault(); const pos=computeDropPosition(e,div,n); markDrop(div,pos); dropTarget={targetId:n.id,pos}; }); div.addEventListener('dragleave',()=>{ unmarkDrop(div); }); div.addEventListener('drop',(e)=>{ e.preventDefault(); if(!draggingId) return; performDrop(n.id); clearDropStyles(); }); container.appendChild(div); if(n.type==='folder'){ (n.children||[]).forEach(c=> renderNode(c, container, depth+1)); } }
    function smallBtn(txt,fn,title){ const b=document.createElement('button'); b.className='pill'; b.textContent=txt; b.addEventListener('click',fn); b.title=title||''; return b; }
    function computeDropPosition(e,div,node){ const r=div.getBoundingClientRect(); const y=e.clientY - r.top; const third=r.height/3; if(y<third) return 'before'; if(y>r.height-third) return 'after'; return node.type==='folder' ? 'inside' : 'after'; }
    function markDrop(div,pos){ unmarkDrop(div); div.classList.add('drop-'+pos); }
    function unmarkDrop(div){ div.classList.remove('drop-before','drop-after','drop-inside'); }
    function clearDropStyles(){ document.querySelectorAll('.node').forEach(n=> n.classList.remove('dragging','drop-before','drop-after','drop-inside')); }
    function performDrop(targetId){ const srcId=draggingId; draggingId=null; if(!srcId || !targetId || srcId===targetId) return; const targetInfo=dropTarget||{targetId,pos:'after'}; const pos=targetInfo.pos; if(pos==='inside' && isDescendant(srcId,targetId)) return; if(isDescendant(srcId,targetId) && pos!=='inside') return; const moved=removeById(srcId); if(!moved) return; const tParent=findParent(state.tree,targetInfo.targetId); if(!tParent) return; if(pos==='inside'){ const tNode=tParent.parentArray[tParent.index]; if(tNode.type!=='folder'){ insertAt(tParent.parentArray,moved,tParent.index+1); } else { tNode.children=tNode.children||[]; tNode.children.push(moved); } } else if(pos==='before'){ insertAt(tParent.parentArray,moved,tParent.index); } else { insertAt(tParent.parentArray,moved,tParent.index+1); } save(); renderTree(); }
    function insertAt(arr,item,index){ arr.splice(index,0,item); }

    /* ===== CRUD ===== */
    async function renameNode(nid){ const n=findNode(state.tree,nid); if(!n) return; const v=await nameDialog({title:'Rename',label:'New name',value:n.name}); if(v===null) return; n.name=v.trim()||n.name; save(); renderTree(); if(nid===state.currentId && els.title) els.title.value=n.name; }
    function deleteNode(nid){ if(!confirm('Delete item? (Folders delete all children)')) return; removeById(nid); if(state.currentId===nid) state.currentId=null; save(); renderTree(); openFirstScene(); }
    on(els.addFolder, 'click', async ()=>{ try{ console.log('Add Folder clicked. selectedFolderId=', selectedFolderId); const name=await nameDialog({title:'New Folder',label:'Folder name',value:'New Folder'}); if(!name){ console.warn('Add Folder cancelled'); return; } const folder={id:id(), type:'folder', name:name.trim(), children:[]}; const parent= selectedFolderId ? findNode(state.tree, selectedFolderId) : null; if(parent && parent.type==='folder'){ parent.children=parent.children||[]; parent.children.push(folder); } else { state.tree.push(folder); } selectedFolderId=folder.id; save(); renderTree(); }catch(err){ console.error('Add Folder failed',err); Debug.open(); } }, 'addFolder');
    on(els.addScene, 'click', async ()=>{ try{ console.log('Add Scene clicked. selectedFolderId=', selectedFolderId); const name=await nameDialog({title:'New Scene',label:'Scene name',value:'New Scene'}); if(!name){ console.warn('Add Scene cancelled'); return; } const sceneNode={id:id(), type:'scene', name:name.trim(), content:''}; const parent= selectedFolderId ? findNode(state.tree, selectedFolderId) : null; if(parent && parent.type==='folder'){ parent.children=parent.children||[]; parent.children.push(sceneNode); } else { state.tree.push(sceneNode); } save(); renderTree(); openNode(sceneNode.id); }catch(err){ console.error('Add Scene failed',err); Debug.open(); } }, 'addScene');
    function openNode(nid){ const n=findNode(state.tree,nid); if(!n || n.type!=='scene') return; state.currentId=nid; save(); if(els.title) els.title.value=n.name; if(els.scene) els.scene.value=n.content||''; if(els.scene) { els.scene.style.flex=''; els.scene.style.height=''; } if(els.preview) { els.preview.style.flex=''; els.preview.style.height=''; els.preview.value=''; } renderTree(); updateWC(); }

    /* ===== Scene Edits ===== */
    on(els.title,'input', ()=>{ const n=findNode(state.tree,state.currentId); if(!n) return; n.name=els.title.value; save(); renderTree(); }, 'title');
    on(els.scene,'input', ()=>{ const n=findNode(state.tree,state.currentId); if(!n) return; n.content=els.scene.value; save(); updateWC(); }, 'scene');
    function updateWC(){ if(!els.scene||!els.wc) return; const t=els.scene.value.trim(); els.wc.textContent=(t?t.split(/\s+/).length:0)+' words'; }

    /* ===== Meta/Outline ===== */
    on(els.projectTitle,'input', ()=>{ state.meta.projectTitle=els.projectTitle.value; save(); document.title=`${state.meta.projectTitle||'Untitled'} ‚Äî MainPlot v4.0`; }, 'projectTitle');
    [els.notes,els.style,els.tone,els.creativity].forEach(el=>{ on(el,'input', ()=>{ state.meta.notes=els.notes?.value||''; state.meta.style=els.style?.value||''; state.meta.tone=els.tone?.value||''; state.meta.creativity=els.creativity?.value||'balanced'; save(); }, el?.id); });
    on(els.outline,'input', ()=>{ state.meta.outline=els.outline.value; save(); }, 'outline');
    on(els.outlineEnabled,'change', ()=>{ state.meta.outlineEnabled=!!els.outlineEnabled.checked; save(); }, 'outlineEnabled');

    /* ===== ACTION OPTIONS (two‚Äëstep) ===== */
    const DEFAULT_OPTS={
      continue:{ length:'medium', tempo:'steady' },
      rewrite:{ strength:'medium', focus:'voice' },
      expand:{ size:'para', focus:'emotion' },
      conflict:{ type:'interpersonal', intensity:'moderate' },
      describe:{ mode:'cinematic', focus:'mixed' },
      summarize:{ format:'bullets', scope:'scene' },
      brainstorm:{ count:'5', spice:'fresh' }
    };

    const OPTION_SPECS={
      continue:{
        length:[['short','2‚Äì3 paragraphs'],['medium','3‚Äì5 paragraphs'],['long','~600 words']],
        tempo:[['steady','Steady'],['brisk','Brisk'],['lingering','Lingering']]
      },
      rewrite:{
        strength:[['light','Light polish'],['medium','On‚Äëvoice rewrite'],['bold','Bold rewrite']],
        focus:[['voice','Voice'],['clarity','Clarity'],['pacing','Pacing']]
      },
      expand:{
        size:[['sentences','+3‚Äì5 sentences'],['para','+1‚Äì2 paragraphs']],
        focus:[['emotion','Emotion'],['setting','Setting'],['action','Action']]
      },
      conflict:{
        type:[['internal','Internal'],['interpersonal','Interpersonal'],['external','External']],
        intensity:[['subtle','Subtle'],['moderate','Moderate'],['high','High']]
      },
      describe:{
        mode:[['cinematic','Cinematic'],['intimate','Intimate'],['objective','Objective']],
        focus:[['visual','Visual'],['auditory','Auditory'],['mixed','Mixed']]
      },
      summarize:{
        format:[['bullets','Bullets'],['paragraph','Paragraph']],
        scope:[['scene','Scene'],['chapter','Chapter']]
      },
      brainstorm:{
        count:[['3','3 ideas'],['5','5 ideas'],['8','8 ideas']],
        spice:[['safe','Safe'],['fresh','Fresh'],['wild','Wild']]
      }
    };

    function getOpts(action){ const saved=state.meta.actionOptions?.[action]; return Object.assign({}, DEFAULT_OPTS[action]||{}, saved||{}); }
    function setOpt(action, key, val){ state.meta.actionOptions=state.meta.actionOptions||{}; state.meta.actionOptions[action]=Object.assign({}, getOpts(action), {[key]:val}); save(); }

    function buildOptionsUI(action){ const wrap=els.optionsStrip; if(!wrap) return; const spec=OPTION_SPECS[action]; if(!spec){ wrap.classList.remove('open'); wrap.innerHTML=''; return; }
      wrap.innerHTML=''; wrap.classList.add('open'); const current=getOpts(action);
      Object.entries(spec).forEach(([group, arr])=>{
        const g=document.createElement('div'); g.className='group';
        const label=document.createElement('span'); label.className='label'; label.textContent=group+':'; g.appendChild(label);
        arr.forEach(([val, labelText])=>{
          const b=document.createElement('button'); b.className='chip'+(current[group]===val?' active':''); b.textContent=labelText; b.title=`${group}: ${labelText}`;
          b.addEventListener('click', ()=>{ setOpt(action, group, val); if(els.preview) els.preview.value=buildPrompt(action, collectContext()); highlightOptions(action); });
          g.appendChild(b);
        });
        wrap.appendChild(g);
      });
      // Clear button
      const clear=document.createElement('button'); clear.className='chip'; clear.textContent='Reset'; clear.title='Reset options to default';
      clear.addEventListener('click', ()=>{ state.meta.actionOptions[action]=Object.assign({}, DEFAULT_OPTS[action]||{}); save(); if(els.preview) els.preview.value=buildPrompt(action, collectContext()); highlightOptions(action); });
      wrap.appendChild(clear);
      highlightOptions(action);
    }
    function highlightOptions(action){ const current=getOpts(action); const wrap=els.optionsStrip; if(!wrap) return; Array.from(wrap.querySelectorAll('.group')).forEach(g=>{ const label=g.querySelector('.label')?.textContent.replace(':',''); const btns=g.querySelectorAll('.chip'); btns.forEach((b,i)=>{ const spec=OPTION_SPECS[action][label]; const val=spec && spec[i] && spec[i][0]; if(val){ if(current[label]===val) b.classList.add('active'); else b.classList.remove('active'); } }); }); }

    /* ===== Prompt Builder ===== */
    Array.from(document.querySelectorAll('.btn')).forEach(b=> on(b,'click', ()=>{ lastAction=b.dataset.action||'continue'; const ctx=collectContext(); if(els.preview) els.preview.value=buildPrompt(lastAction, ctx); buildOptionsUI(lastAction); scrollPreviewIntoView(); }, b.textContent.trim()));
    on(els.copyPrompt,'click', async ()=>{ const txt=(els.preview?.value||'').trim(); if(!txt){ status('Nothing to copy.','warn'); return; } const ok=await copyToClipboard(txt); status(ok? 'Copied! Paste into ChatGPT.' : 'Copy failed ‚Äî text selected so you can copy with Ctrl/Cmd+C.', ''+(ok?'ok':'danger')); if(!ok && els.preview){ els.preview.focus(); els.preview.select(); } }, 'copyPrompt');
    function status(msg, cls){ if(!els.copyStatus) return; els.copyStatus.textContent=msg; els.copyStatus.className='small '+cls; clearTimeout(status._t); status._t=setTimeout(()=>{ if(els.copyStatus) els.copyStatus.textContent=''; },3000); }

    async function copyToClipboard(text){ try{ if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); return true; } }catch{} try{ const ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.top='-1000px'; document.body.appendChild(ta); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok) return true; }catch{} return false; }

    function collectContext(){ const n=findNode(state.tree,state.currentId)||{}; return { projectTitle:state.meta.projectTitle||'', notes:state.meta.notes||'', style:state.meta.style||'', tone:state.meta.tone||'', creativity:state.meta.creativity||'balanced', sceneName:n.name||'', scene:n.content||'', selection:getSelectionFromTextarea(els.scene) }; }
    function getSelectionFromTextarea(ta){ return ta? ta.value.substring(ta.selectionStart||0, ta.selectionEnd||0).trim() : ''; }

    function buildPrompt(action,c){ const creativityMap={ precise:"Be conservative and faithful to the source. Avoid inventing new facts.", balanced:"Balance fidelity with light creativity. Avoid contradictions.", imaginative:"Be bold and inventive while preserving canon and tone." }; const toneLine=c.tone? `Tone: ${c.tone}.` : `Tone: inherit from the text.`; const header=`You are an expert fiction writing assistant and developmental editor.\nHonor canon and voice. Keep tense/POV consistent.\n${toneLine} ${creativityMap[c.creativity]||creativityMap.balanced}\nIf rewriting, preserve meaning; if continuing, match cadence and voice.`; const canon=`PROJECT: ${c.projectTitle||'(untitled)'}\nPROJECT NOTES:\n${c.notes||'(none)'}\nSTYLE GUIDE:\n${c.style||'(none)'}`; let outlineBlock=''; if(state.meta.outlineEnabled){ const chapter=extractChapterSection(state.meta.outline, c.sceneName); if(chapter){ outlineBlock=`OUTLINE (chapter‚Äërelevant):\n${chapter}`; } else { const shorty=trimOutline(state.meta.outline, 900); if(shorty) outlineBlock=`OUTLINE (summary):\n${shorty}`; } }
      const opt = getOpts(action);
      const optText = optionsToText(action,opt);
      let task='';
      switch(action){
        case 'continue': task='TASK: Continue the scene naturally. End on a light hook. Avoid summarizing; write lived‚Äëin prose.'; break;
        case 'rewrite': task='TASK: Rewrite the SELECTION stronger and on‚Äëvoice. Preserve meaning. Offer 2 variants if helpful.'; break;
        case 'expand': task="TASK: Expand the SELECTION with vivid, concrete detail (show, don‚Äôt tell). Keep pacing."; break;
        case 'conflict': task='TASK: Introduce organic conflict/tension appropriate to the scene (stakes, obstacle, reversal).'; break;
        case 'describe': task='TASK: Sensory description grounded in POV (sight/sound/smell/touch/taste as appropriate).'; break;
        case 'summarize': task='TASK: Summarize the scene in 5 bullets: beats, goals, conflict, turning point, open questions.'; break;
        case 'brainstorm': task='TASK: Brainstorm distinct next‚Äëbeat options (1‚Äì2 sentences each). Include tradeoffs. Keep within canon.'; break;
        default: task='TASK: Continue the scene, matching voice and cadence.'; }
      const sel=c.selection? `SELECTION:\n${c.selection}` : '(No selection provided.)'; const scene=c.scene? `CURRENT SCENE ‚Äî ${c.sceneName}:\n${c.scene}` : '(No scene text provided.)'; return [header, canon, outlineBlock, task, optText, sel, scene].filter(Boolean).join('\n\n---\n\n'); }

    function optionsToText(action,opt){
      switch(action){
        case 'continue': return `PREFERENCES: Target length: ${ opt.length==='short'?'2‚Äì3 paragraphs': opt.length==='long'?'~600 words':'3‚Äì5 paragraphs' }. Tempo: ${opt.tempo}.`;
        case 'rewrite': return `PREFERENCES: Rewrite strength: ${opt.strength}. Primary focus: ${opt.focus}.`;
        case 'expand': return `PREFERENCES: Add ${opt.size==='sentences'?'+3‚Äì5 sentences':'+1‚Äì2 paragraphs'} focusing on ${opt.focus}.`;
        case 'conflict': return `PREFERENCES: Conflict type: ${opt.type}. Intensity: ${opt.intensity}.`;
        case 'describe': return `PREFERENCES: Style: ${opt.mode}. Sensory focus: ${opt.focus}.`;
        case 'summarize': return `PREFERENCES: Format: ${opt.format}. Scope: ${opt.scope}.`;
        case 'brainstorm': return `PREFERENCES: Provide ${opt.count} ideas with ${opt.spice} risk level.`;
        default: return '';
      }
    }

    /* ===== Outline helpers ===== */
    function extractChapterSection(outline,sceneName){ if(!outline || !sceneName) return ''; const lines=outline.split(/\r?\n/); const ch=(sceneName.match(/chapter\s*(\d+)/i)||[])[1]; let headerRegex; if(ch){ headerRegex=new RegExp(`^###\\s+Chapter\\s*${ch}\\b`,'i'); } else { const key=sceneName.replace(/^[^:]*:\s*/, '').trim().split(/\s+/).slice(0,4).join(' '); if(!key) return ''; const esc=key.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); headerRegex=new RegExp(`^###\\s+.*${esc}.*$`,'i'); } let start=-1, end=lines.length; for(let i=0;i<lines.length;i++){ if(headerRegex.test(lines[i])){ start=i; break; } } if(start===-1) return ''; for(let j=start+1;j<lines.length;j++){ if(/^###\s+/.test(lines[j])){ end=j; break; } } return lines.slice(start,end).join('\n'); }
    function trimOutline(outline,maxChars){ if(!outline) return ''; outline=outline.trim(); return outline.length>maxChars? outline.slice(0,maxChars)+'‚Ä¶' : outline; }
    on(els.btnGenOutline,'click', ()=>{ const ctx=collectContext(); const prompt=`You are a story structure coach. Build a clean, chapter‚Äëby‚Äëchapter outline from PROJECT NOTES (and optional scene text), using:\n- Headings: "### Chapter N: Title"\n- 2‚Äì5 concise beats per chapter ("- Beat: ...")\n- Optional Acts as "## Act I/II/III".\n\nPROJECT NOTES:\n${state.meta.notes || '(none)'}\n\nOPTIONAL SCENE CONTEXT (may be partial):\n${ctx.scene || '(none)'}\n`; if(els.preview) els.preview.value=prompt; els.optionsStrip && els.optionsStrip.classList.remove('open'); scrollPreviewIntoView(); }, 'btnGenOutline');
    on(els.btnSceneToOutline,'click', ()=>{ const ctx=collectContext(); const prompt=`Summarize the CURRENT SCENE into 3‚Äì6 "Beat:" lines suitable for the global outline.\nKeep names, stakes, turning point, and consequences.\n\nCURRENT SCENE ‚Äî ${ctx.sceneName}:\n${ctx.scene || '(empty)'}\n`; if(els.preview) els.preview.value=prompt; els.optionsStrip && els.optionsStrip.classList.remove('open'); scrollPreviewIntoView(); }, 'btnSceneToOutline');
    on(els.exportOutline,'click', ()=>{ const blob=new Blob([state.meta.outline||''],{type:'text/markdown'}); downloadBlob(blob,(state.meta.projectTitle||'outline')+'.md'); }, 'exportOutline');

    /* ===== Export / Backup ===== */
    on(els.exportTxt,'click', ()=>{ const n=findNode(state.tree,state.currentId); if(!n) return; downloadBlob(new Blob([n.content||''],{type:'text/plain'}),(n.name||'scene')+'.txt'); }, 'exportTxt');
    on(els.backup,'click', ()=> { backupProject(); }, 'backup');
    on(els.restore,'click', ()=> els.restoreFile && els.restoreFile.click(), 'restore');
    on(els.restoreFile,'change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ state=JSON.parse(await f.text()); save(); hydrateMeta(); selectedFolderId=null; renderTree(); openFirstScene(); logBackup('Restore complete'); }catch{ alert('Invalid backup file'); } e.target.value=''; }, 'restoreFile');

    function downloadBlob(blob, name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(name||'download').replace(/[^\w\-\.]+/g,'_'); document.body.appendChild(a); a.click(); a.remove(); showManualDownload(url, name); }

    let _manualTimer=null, _lastUrl=null;
    function showManualDownload(url, name){ try{ if(_manualTimer){ clearTimeout(_manualTimer); _manualTimer=null; } if(_lastUrl && _lastUrl!==url){ try{ URL.revokeObjectURL(_lastUrl); }catch{} } _lastUrl=url; const link=els.backupManual; if(!link) return; link.href=url; link.download=(name||'backup.json').replace(/[^\w\-\.]+/g,'_'); link.style.display='inline'; logBackup('Download triggered. Manual link shown.'); _manualTimer=setTimeout(()=>{ link.style.display='none'; try{ URL.revokeObjectURL(url); }catch{} }, 60000); }catch(err){ console.error('Manual link setup failed',err); } }

    async function backupProject(){ try{ const filename=(state.meta.projectTitle||'project')+'_backup.json'; const data=JSON.stringify(state,null,2); logBackup('Starting backup‚Ä¶'); if(window.showSaveFilePicker){ try{ const handle=await window.showSaveFilePicker({ suggestedName: filename, types:[{ description:'JSON', accept:{ 'application/json':['.json'] } }] }); const writable=await handle.createWritable(); await writable.write(new Blob([data],{type:'application/json'})); await writable.close(); logBackup('Saved via file picker.'); return true; }catch(err){ logBackup('Save picker not used / cancelled'); } } try{ downloadBlob(new Blob([data],{type:'application/json'}), filename); return true; }catch(err){ console.error('Download method failed',err); } try{ await navigator.clipboard.writeText(data); logBackup('Backup copied to clipboard.'); toastBackup('Backup JSON copied to clipboard.', 'ok'); return true; }catch(err){ console.error('Clipboard backup failed',err); } $('rawText').value=data; openRaw(true); logBackup('Showing backup JSON in window. You can copy manually.'); toastBackup('Could not download ‚Äî showing JSON to copy.', 'warn'); return false; }catch(err){ console.error('Backup crashed',err); toastBackup('Backup failed', 'danger'); Debug.open(); return false; } }

    function logBackup(msg){ console.log('BACKUP:', msg); toastBackup(msg,''); }
    function toastBackup(msg, cls){ const el=els.backupStatus; if(!el) return; el.textContent=msg; el.className='small '+(cls||''); clearTimeout(toastBackup._t); toastBackup._t=setTimeout(()=> { if(el) el.textContent=''; }, 5000); }

    /* ===== Raw modal helpers ===== */
    const rawBox=$('rawModal');
    function openRaw(open){ if(!rawBox) return; if(open){ rawBox.classList.add('open'); } else { rawBox.classList.remove('open'); } }
    on($('rawHide'),'click',()=> openRaw(false),'rawHide');
    on($('rawClose'),'click',()=> openRaw(false),'rawClose');
    on($('rawCopy'),'click',async()=>{ try{ await navigator.clipboard.writeText($('rawText')?.value||''); toastBackup('Copied JSON to clipboard.','ok'); }catch{ toastBackup('Clipboard blocked ‚Äî select all and copy.','warn'); } },'rawCopy');

    /* ===== Drag‚Äëresize Preview (mouse + touch) ===== */
    (function(){ const bar=$('dragbar'); const scene=$('scene'); const preview=$('preview'); if(!bar||!scene||!preview) return; let dragging=false, startY=0, startSceneH=0, startPrevH=0; function startDrag(y){ dragging=true; startY=y; startSceneH=scene.getBoundingClientRect().height; startPrevH=preview.getBoundingClientRect().height; scene.style.flex=`0 0 ${startSceneH}px`; preview.style.flex=`0 0 ${startPrevH}px`; document.body.style.userSelect='none'; } function moveDrag(y){ if(!dragging) return; const dy=y-startY; const newSceneH=Math.max(100, startSceneH + dy); const newPrevH=Math.max(100, startPrevH - dy); scene.style.flex=`0 0 ${newSceneH}px`; preview.style.flex=`0 0 ${newPrevH}px`; } function endDrag(){ dragging=false; document.body.style.userSelect=''; } on(bar,'mousedown',(e)=> startDrag(e.clientY),'dragbar_mousedown'); window.addEventListener('mousemove',(e)=> moveDrag(e.clientY)); window.addEventListener('mouseup', endDrag); on(bar,'touchstart',(e)=>{ const t=e.touches[0]; startDrag(t.clientY); },'dragbar_touchstart'); window.addEventListener('touchmove',(e)=>{ const t=e.touches[0]; moveDrag(t.clientY); }); window.addEventListener('touchend', endDrag); on(bar,'dblclick', ()=>{ scene.style.flex=''; preview.style.flex=''; },'dragbar_dblclick'); })();

    /* ===== Panel Toggles ===== */
    on(els.toggleLeft,'click', ()=> { if(!els.left) return; els.left.style.display = (els.left.style.display==='none'?'':'none'); }, 'toggleLeft');
    on(els.toggleRight,'click', ()=> { if(!els.right) return; els.right.style.display = (els.right.style.display==='none'?'':'none'); }, 'toggleRight');
    function scrollPreviewIntoView(){ $('preview')?.scrollIntoView({block:'center',behavior:'smooth'}); }

    /* ===== Help & Debug ===== */
    function openHelp(){ els.helpModal?.classList.add('open'); els.helpModal?.setAttribute('aria-hidden','false'); }
    function closeHelp(){ els.helpModal?.classList.remove('open'); els.helpModal?.setAttribute('aria-hidden','true'); }
    on(els.helpBtn,'click', openHelp,'helpBtn'); on(els.helpClose,'click', closeHelp,'helpClose'); on(els.helpModal,'click',(e)=>{ if(e.target===els.helpModal) closeHelp(); },'helpModalBackdrop');
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && !e.shiftKey && !e.altKey && e.key.toLowerCase()==='d'){ e.preventDefault(); Debug.toggle(); } });

    /* ===== Keyboard Shortcuts ===== */
    function isMod(e){ return e.ctrlKey || e.metaKey; }
    function smartBuild(){ const hasSel=!!getSelectionFromTextarea(els.scene); const action=hasSel? 'rewrite' : (lastAction||'continue'); const ctx=collectContext(); if(els.preview) els.preview.value=buildPrompt(action, ctx); buildOptionsUI(action); scrollPreviewIntoView(); }
    window.addEventListener('keydown', (e)=>{
      if(e.key==='F1' || (e.shiftKey && (e.key==='?' || e.key==='/'))){ e.preventDefault(); openHelp(); return; }
      if(e.key==='Escape'){ closeHelp(); return; }
      if(e.altKey && !isMod(e)){
        const map={ '1':'continue','2':'rewrite','3':'expand','4':'conflict','5':'describe','6':'summarize','7':'brainstorm' };
        if(map[e.key]){ e.preventDefault(); lastAction=map[e.key]; if(els.preview) els.preview.value=buildPrompt(lastAction, collectContext()); buildOptionsUI(lastAction); scrollPreviewIntoView(); }
      }
      if(isMod(e) && e.key==='Enter'){ e.preventDefault(); smartBuild(); }
      if(isMod(e) && e.shiftKey && (e.key.toLowerCase()==='c')){ e.preventDefault(); els.copyPrompt && els.copyPrompt.click(); }
      if(isMod(e) && !e.shiftKey && !e.altKey){ const k=e.key.toLowerCase(); if(k==='b'){ e.preventDefault(); backupProject(); } else if(k==='o'){ e.preventDefault(); els.restore && els.restore.click(); } else if(k==='e'){ e.preventDefault(); $('exportTxt') && $('exportTxt').click(); } }
      if(isMod(e) && e.shiftKey){ const k=e.key.toLowerCase(); if(k==='g'){ e.preventDefault(); els.btnGenOutline && els.btnGenOutline.click(); } else if(k==='s'){ e.preventDefault(); els.btnSceneToOutline && els.btnSceneToOutline.click(); } }
      if(isMod(e) && e.altKey){ const k=e.key.toLowerCase(); if(k==='l'){ e.preventDefault(); els.toggleLeft && els.toggleLeft.click(); } else if(k==='n'){ e.preventDefault(); els.toggleRight && els.toggleRight.click(); } }
    });

    /* ===== Self‚Äëtests (lightweight) ===== */
    (function runSelfTests(){
      const requiredIds=['left','right','tree','addFolder','addScene','backup','restore','restoreFile','title','scene','preview','notes','style','tone','creativity','outline','outlineEnabled','copyPrompt','toggleLeft','toggleRight','helpBtn','helpModal','helpClose','backupStatus','backupManual','optionsStrip'];
      let ok=true; requiredIds.forEach(id=>{ if(!$(id)){ ok=false; console.error('TEST FAIL: missing #'+id); } });
      try{ const p=buildPrompt('continue', collectContext()); if(typeof p!=='string'){ ok=false; console.error('TEST FAIL: buildPrompt did not return string'); } }catch(e){ ok=false; console.error('TEST FAIL: buildPrompt threw', e); }
      console.log(ok? 'TEST PASS: Basic UI & functions present' : 'TEST WARN: One or more checks failed');
    })();

  }); // DOMContentLoaded
</script>
</body>
</html>
